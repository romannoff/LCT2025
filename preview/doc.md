# LCT2025 — Полная сопроводительная документация

----------

## Содержание

1.  README — установка и запуск
    
2.  Архитектурная диаграмма и описание компонентов
    
3.  Документация API с примерами
    
4.  Руководство по интеграции с медицинским оборудованием
    
5.  Описание алгоритмов обработки и анализа сигналов
    
6.  Алгоритмы выявления аномалий и построения прогнозов
    
7.  Обоснование выбора ML‑моделей и метрики качества
    
8.  Руководство пользователя для медицинского персонала
    
9.  Техническое описание реализации: стек, оптимизации, развёртывание и требования к HW
    

----------

# 1. README — инструкции по инсталляции и развёртыванию

**Кратко:** проект — MVP веб‑платформы для мониторинга CTG (кардиотокография): прием потоковых и архивных данных, извлечение паттернов (дeцелерации, тахикардия, брадикардия, вариабельность и др.), краткосрочные прогнозы, веб‑дашборд и API.

## Система требований

-   Python 3.10+ (рекомендуется 3.11)
    
-   Docker & docker-compose (рекомендовано для развёртывания)
    
-   Ресурсы: минимум 2 CPU, 2 GB RAM для локальной демонстрации; для real‑time и ML — рекомендуется 4 CPU и 4+ GB RAM
    

## Быстрый старт (Docker)

1.  Клонировать репо:
    

```bash
git clone https://github.com/romannoff/LCT2025.git
cd LCT2025

```

2.  Сборка и запуск контейнеров:
    

```bash
docker-compose up --build -d

```

3.  Откройте:
    

-   API /docs: `http://localhost:2727/docs`
    
-   Dashboard: `http://localhost:2727/` (статические ресурсы в `static/`)
    

## Локальный запуск без Docker

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn src.app:app --host 0.0.0.0 --port 8000 --reload

```

## Тестирование эмулятора

Пример запуска эмулятора (stream simulator):

```bash
python src/sampler.py --bpm data/sample_bpm.csv --uterus data/sample_uterus.csv --patient patient_1 --rate 1.0

```

Эмулятор шлёт измерения в `POST /api/v1/measurements` либо напрямую в приложение (в зависимости от конфигурации).

----------

# 2. Архитектурная диаграмма системы с описанием компонентов

Ниже — высокоуровневая архитектура (Mermaid):



## Описание компонентов

-   **Фетальный монитор / устройство (Device)** — генерирует два типа сигналов: BPM (частота сердцебиения плода) и Uterus (сила/активность маточных сокращений). Может слать данные по TCP/HTTP/HL7/USB.
    
-   **Ingest API (FastAPI)** — приём данных в реальном времени через REST `POST /api/v1/measurements` и WebSocket подписку для клиентов. API также предоставляет загрузку архивов для анализов.
    
-   **Stream Processing Engine** — управляет потоковой обработкой: буферизация (sliding window), нормализация timestamp, удаление артефактов, агрегация фрагментов.
    
-   **Feature Extractor** — вычисляет признаки: скользящая средняя, SDNN, RMSSD, число декелераций, длительность эпизодов, частота и амплитуда сокращений матки и т.д.
    
-   **Anomaly Detectors** — rule‑based + lightweight ML для обнаружения декелераций, тахикардии/брадикардии, потери вариабельности и др.
    
-   **Predictive Models** — краткосрочные прогнозы (15–60+ минут) и оценка вероятности осложнений (гипоксия, необходимость вмешательства). Модели запускаются в режиме inference на признаках.
    
-   **Event Store / Annotations DB** — хранение детектированных событий, аннотаций и метаданных сессии. В MVP может быть файловая база (JSON), в production — PostgreSQL.
    
-   **Alerts Engine** — формирует цветовые статусы и уведомления для интерфейса / внешних интеграций (Webhook/HL7).
    
-   **WebSocket Broadcaster** — раздаёт обновления (features, events, прогнозы) подключённым дашбордам.
    
-   **Dashboard (frontend)** — визуализация сигналов, аннотаций и прогнозов в реальном времени.
    
-   **Batch Analyzer** — обработка архивных записей (CSV) для обучения/валидации и создания демо‑отчётов.
    

----------

# 3. Документация API с примерами запросов и ответов

> Все endpoints доступны в Swagger UI (`/docs`) после запуска.

## Форматы времени

Во всех JSON используем unix timestamp (float) в секундах с дробной частью.

## 1) Приём измерения

**POST** `/api/v1/measurements`

**Тело (JSON):**

```json
{
  "patient_id": "patient_1",
  "type": "bpm",
  "value": 142.0,
  "timestamp": 1690000000.123
}

```

**Ответ:** `202 Accepted`

**Поведение:** Сервис валидирует и помещает измерение в буфер обработки; если подключён WebSocket‑клиент — посылает обновление.

## 2) WebSocket подписка

**URL:** `ws://HOST:2727/ws/{patient_id}`

**Сообщения от сервера:**

```json
{
  "timestamp": 1690000000.0,
  "type": "update",
  "data": {
    "latest": {"bpm": 142.0, "uterus": 0.2},
    "features": {"sdnn": 8.2, "rmssd": 5.1},
    "events": [
      {"type":"deceleration","start":1690000000.0,"end":1690000020.0,"severity":"moderate"}
    ],
    "prediction": {"hypoxia_risk_pct": 12.3, "advice":"continue monitoring"}
  }
}

```

## 3) Загрузка архива и пакетный анализ

**POST** `/api/v1/analyze_archive/{patient_id}`

**Форма (multipart/form-data):**

-   `bpm_file` — CSV `timestamp,value`
    
-   `uterus_file` — CSV `timestamp,value`
    
-   опционально `metadata` — JSON (history, gestational_age, parity)
    

**Ответ (JSON):**

```json
{
  "patient_id": "patient_1",
  "duration_sec": 3600,
  "events": [ ... ],
  "summary": {"avg_bpm": 140.2, "min_bpm": 115, "max_bpm": 170},
  "prediction": {"hypoxia_risk_pct": 25.0}
}

```

## 4) Получение истории событий

**GET** `/api/v1/sessions/{patient_id}/events?from=...&to=...`

**Ответ:** список аннотаций и событий.

## Примеры cURL

```bash
curl -X POST "http://localhost:2727/api/v1/measurements" \
  -H "Content-Type: application/json" \
  -d '{"patient_id":"p1","type":"bpm","value":140.0,"timestamp":1690000000.0}'

```

```bash
curl -X POST "http://localhost:2727/api/v1/analyze_archive/p1" \
  -F "bpm_file=@data/sample_bpm.csv" -F "uterus_file=@data/sample_uterus.csv"

```
    
# 4. Методы обработки и анализа физиологических сигналов

## Предобработка

1.  **Синхронизация по времени:** приведение всех сигналов к общему временнóму базису (интерполяция/ресемплинг до 1 Hz или до native sampling для заданных методов).
    
2.  **Фильтрация артефактов:** удаление нулевых/внедиапазонных значений; сглаживание (взвешенное скользящее среднее) для удаления выбросов.
    
3.  **Segmenting / Windowing:** использование sliding windows (например, 60s window с шагом 10s) для вычисления скользящих признаков.
    

## Извлекаемые признаки (features)

-   **Временные признаки:** mean, min, max, median, std (BPM)
    
-   **HRV параметры:** SDNN, RMSSD, pNN50 (приближённые метрики для дискретных beat‑to‑beat если это возможно)
    
-   **Децелерации/акцелерации:** количество эпизодов, длительность, глубина
    
-   **Частота маточных сокращений:** пики, частота, area under contraction curve
    
-   **Соотношения:** bpm/uterus cross‑correlation (корреляция между сокращениями матки и изменениями ЧСС)
    

## Детекция событий (rule‑based)

Примеры правил:

-   **Тахикардия:** BPM > 160 длительностью ≥ 10 минут (или 3–5 минут для краткосрочных триггеров)
    
-   **Брадикардия:** BPM < 110 длительностью ≥ 10 минут
    
-   **Децелерация:** падение BPM на ≥ 15 ударов/мин относительно базовой линии в течение ≥ 15 секунд (условные значения — калибруются по аннотациям датасета)
    

----------

# 5. Алгоритмы выявления аномалий и построения прогнозов

## Подходы

-   **Гибридная схема:** rule‑based детекторы для явных клинических правил + ML‑модель для сложных паттернов и прогнозирования рисков.
    
-   **Streaming inference:** модели принимают признаки из последних N минут и возвращают риск гипоксии.
    

## Пример pipeline (streaming)

1.  На каждое новое измерение обновляется буфер памяти.
    
2.  Запускается FeatureExtractor на полученных данных.
    
3.  Detectors проверяют признаки на наличие событий (выполняются быстрые проверки правил).
    
4.  Каждые 10 секунд запускается ML‑инференс (CatBoost) на тех же признаках для расчёта вероятности гипоксии / необходимости вмешательства.
    
5.  Результат публикуется в WebSocket и при превышении порога — генерируется Alert.
    

## Пороговые стратегии

-   Порог риска может быть представлен как «green/yellow/red» с порогами (например, <10% — green, 10–30% — yellow, >30% — red) — калибруется клинически.
    

----------

# 6. Обоснование выбора ML‑моделей и их характеристики

## Требования к модели

-   Низкое потребление CPU/RAM
    
-   Быстрый inference (<100 ms на edge‑устройстве)
    
-   Интерпретируемость (важна для клиницистов)
    
-   Умеренная точность на коротких окнах (15–60 минут)
    

## Выбор

-   **Logistic Regression / LightGBM (shallow)** — компромисс точность/скорость/интерпретируемость. Позволяют извлечь feature importance и быстро inference на CPU.
    
-   **Почему не сложные сети?** LSTM/Transformer дают прирост качества на длинных временных рядах, но сложнее объяснять клинически и требуют больше ресурсов. 

----------

# 7. Метрики качества работы системы
Accuracy: 0.92
Precision: 0.95
Recall: 0.83
F1: 0.88
    

----------

# 8. Руководство пользователя
![capture](https://github.com/user-attachments/files/22666173/capture_20251002211125718.bmp)

## Основные принципы работы интерфейса
-   В верхней части — идентификатор пациентки, текущий статус (Green/Yellow/Red), время сессии.
    
-   Центр — график BPM (основной) и график uterine activity под ним. Автоматические аннотации декелераций/акцелераций помечены цветными маркерами.
    
-   Правая панель — краткий summary: текущие признаки, прогнозы, выявленные и аномалии.
    

## Интерпретация статусов

-   **Green:** нет текущих признаков риска. Продолжать наблюдение.
    
-   **Yellow:** обнаружены изменения (умеренная декелерация, снижение вариабельности) — усилить наблюдение, возможно увеличить частоту чеков.
    
-   **Red:** высокий риск (высокая вероятность гипоксии/необходимость вмешательства) — немедленно оповестить клиническую команду.
    

## Действия при алерте

1.  Подтвердить данные (проверить электрод/прикрепление).
    
2.  Оценить состояние матери и плода.
    
3.  При необходимости начать протокол экстренного реагирования согласно локальным клиническим инструкциям.
    

## Подсказки для интерпретации прогноза

-   Прогноз — вероятностный; используйте его вместе с клиническим контекстом (анамнез, течение родов).
    
-   При малой количеством данных прогноз менее надёжен.
----------

